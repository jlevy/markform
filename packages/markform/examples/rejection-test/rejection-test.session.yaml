session_version: 0.1.0
mode: mock
form:
  path: rejection-test.form.md
mock:
  completed_mock: rejection-test-mock-filled.form.md
harness:
  max_turns: 100
  max_patches_per_turn: 20
  max_issues_per_turn: 10
  target_roles:
    - '*'
  fill_mode: continue
turns:
  - turn: 1
    inspect:
      issues:
        - ref: ratings
          scope: field
          reason: required_missing
          message: Required field "Ratings" is empty
          severity: required
          priority: 1
        - ref: title
          scope: field
          reason: required_missing
          message: Required field "Title" is empty
          severity: required
          priority: 1
    apply:
      patches:
        - op: set_string
          field_id: ratings
          value: Intentional type mismatch - testing rejection feedback
        - op: set_string
          field_id: title
          value: Test Movie
      rejected_patches:
        - patch_index: 0
          message: Cannot apply set_string to table field "ratings"
          field_id: ratings
          field_kind: table
          column_ids:
            - source
            - score
            - votes
    after:
      required_issue_count: 1
      markdown_sha256: 6dea4cae87738069d3c212e817ac7a59a77fcd3c78d7fac506adf4f5b36caf27
      answered_field_count: 1
      skipped_field_count: 0
    context:
      system_prompt: |-
        # Form Instructions
        Carefully research answers to all questions in the form, using all available tools you have.

        Guidelines:
        1. Focus on required fields first (severity: "required"), then address optional fields (severity: "recommended")
        2. You MUST address ALL issues shown to you - both required AND recommended (optional)
        3. NEVER fabricate or guess information - only use data you can verify
        4. If you cannot find verifiable information for a field, use skip_field to mark it as skipped with a reason
        5. For string fields: use appropriate text from verified sources
        6. For number fields: use appropriate numeric values from verified sources
        7. For single_select: choose one valid option ID
        8. For multi_select: choose one or more valid option IDs
        9. For checkboxes: use the appropriate state for the checkbox mode:
           - Mode "simple": done (checked) or todo (unchecked)
           - Mode "multi": done, todo, or na (not applicable)
           - Mode "explicit": yes or no (must explicitly answer)

        CRITICAL: Accuracy is more important than completeness. Use skip_field when information cannot be verified.

        Always use the fill_form tool to submit your field values.


        # Instructions for agent role
        Complete the remaining fields based on the provided context.

        # Field-specific instructions
        **ratings:** Enter rating data with source name, score (0-100), and vote count.
      context_prompt: |-
        # Current Form State

        Below is the complete form with all currently filled values.
        Fields marked with `[ ]` or empty values still need to be filled.

        ```markdown
        ---
        markform:
          spec: "MF/0.1"
        role_instructions:
          user: "Fill in the fields you have direct knowledge of."
          agent: "Complete the remaining fields based on the provided context."
        ---

        {% form id="rejection_test" title="Rejection Test Form" %}

        {% description ref="rejection_test" %}
        A form to test patch rejection scenarios - verifies that type mismatch
        errors are properly recorded and recovery works.
        {% /description %}

        {% group id="fields" title="Test Fields" %}

        {% field kind="table" id="ratings" columnIds=["source", "score", "votes"] columnLabels=["Source", "Score", "Votes"] columnTypes=["string", "number", "number"] label="Ratings" maxRows=5 minRows=1 required=true %}{% /field %}

        {% instructions ref="ratings" %}
        Enter rating data with source name, score (0-100), and vote count.
        {% /instructions %}

        {% field kind="string" id="title" label="Title" required=true %}{% /field %}

        {% /group %}

        {% /form %}

        ```

        # Current Form Issues

        You need to address 2 issues. Here are the current issues:

        - **ratings** (field): Required field "Ratings" is empty
          Severity: required, Priority: P1
          Type: table
          Columns: source, score, votes
          Rows: min: 1, max: 5
          Set: { op: "set_table", fieldId: "ratings", value: [{ "source": "...", "score": "...", "votes": "..." }, ...] }
          This field is required.

        - **title** (field): Required field "Title" is empty
          Severity: required, Priority: P1
          Type: string
          Set: { op: "set_string", fieldId: "title", value: "..." }
          This field is required.

        # General Instructions

        Use the fill_form tool to submit patches for the fields above.
        For table fields, each row is an object with column ID keys.
    wire:
      request:
        system: |-
          # Form Instructions
          Carefully research answers to all questions in the form, using all available tools you have.

          Guidelines:
          1. Focus on required fields first (severity: "required"), then address optional fields (severity: "recommended")
          2. You MUST address ALL issues shown to you - both required AND recommended (optional)
          3. NEVER fabricate or guess information - only use data you can verify
          4. If you cannot find verifiable information for a field, use skip_field to mark it as skipped with a reason
          5. For string fields: use appropriate text from verified sources
          6. For number fields: use appropriate numeric values from verified sources
          7. For single_select: choose one valid option ID
          8. For multi_select: choose one or more valid option IDs
          9. For checkboxes: use the appropriate state for the checkbox mode:
             - Mode "simple": done (checked) or todo (unchecked)
             - Mode "multi": done, todo, or na (not applicable)
             - Mode "explicit": yes or no (must explicitly answer)

          CRITICAL: Accuracy is more important than completeness. Use skip_field when information cannot be verified.

          Always use the fill_form tool to submit your field values.


          # Instructions for agent role
          Complete the remaining fields based on the provided context.

          # Field-specific instructions
          **ratings:** Enter rating data with source name, score (0-100), and vote count.
        prompt: |-
          # Current Form State

          Below is the complete form with all currently filled values.
          Fields marked with `[ ]` or empty values still need to be filled.

          ```markdown
          ---
          markform:
            spec: "MF/0.1"
          role_instructions:
            user: "Fill in the fields you have direct knowledge of."
            agent: "Complete the remaining fields based on the provided context."
          ---

          {% form id="rejection_test" title="Rejection Test Form" %}

          {% description ref="rejection_test" %}
          A form to test patch rejection scenarios - verifies that type mismatch
          errors are properly recorded and recovery works.
          {% /description %}

          {% group id="fields" title="Test Fields" %}

          {% field kind="table" id="ratings" columnIds=["source", "score", "votes"] columnLabels=["Source", "Score", "Votes"] columnTypes=["string", "number", "number"] label="Ratings" maxRows=5 minRows=1 required=true %}{% /field %}

          {% instructions ref="ratings" %}
          Enter rating data with source name, score (0-100), and vote count.
          {% /instructions %}

          {% field kind="string" id="title" label="Title" required=true %}{% /field %}

          {% /group %}

          {% /form %}

          ```

          # Current Form Issues

          You need to address 2 issues. Here are the current issues:

          - **ratings** (field): Required field "Ratings" is empty
            Severity: required, Priority: P1
            Type: table
            Columns: source, score, votes
            Rows: min: 1, max: 5
            Set: { op: "set_table", fieldId: "ratings", value: [{ "source": "...", "score": "...", "votes": "..." }, ...] }
            This field is required.

          - **title** (field): Required field "Title" is empty
            Severity: required, Priority: P1
            Type: string
            Set: { op: "set_string", fieldId: "title", value: "..." }
            This field is required.

          # General Instructions

          Use the fill_form tool to submit patches for the fields above.
          For table fields, each row is an object with column ID keys.
        tools:
          fill_form:
            description: Fill form fields by submitting patches. Each patch sets a value for one field. Use the field IDs from the issues list. Return patches for all issues you can address.
            input_schema:
              $defs:
                patch:
                  description: A patch operation (see tool description for full schema)
              properties:
                patches:
                  description: Array of patches to apply to the form
                  items:
                    $ref: '#/$defs/patch'
                  type: array
              required:
                - patches
              type: object
      response:
        steps:
          - tool_calls:
              - tool_name: fill_form
                input:
                  patches:
                    - field_id: ratings
                      op: set_string
                      value: Intentional type mismatch - testing rejection feedback
                    - field_id: title
                      op: set_string
                      value: Test Movie
            tool_results: []
            text: null
        usage:
          input_tokens: 0
          output_tokens: 0
  - turn: 2
    inspect:
      issues:
        - ref: ratings
          scope: field
          reason: required_missing
          message: Required field "Ratings" is empty
          severity: required
          priority: 1
    apply:
      patches:
        - op: set_table
          field_id: ratings
          value:
            - source: IMDB
              score: 85
              votes: 12500
            - source: Rotten Tomatoes
              score: 92
              votes: 450
        - op: set_string
          field_id: title
          value: Test Movie
    after:
      required_issue_count: 0
      markdown_sha256: f45e7cd87b036d57564e3340dec33c1dc5c2094d880e52b903f64da19b3b8ec0
      answered_field_count: 2
      skipped_field_count: 0
    context:
      system_prompt: |-
        # Form Instructions
        Carefully research answers to all questions in the form, using all available tools you have.

        Guidelines:
        1. Focus on required fields first (severity: "required"), then address optional fields (severity: "recommended")
        2. You MUST address ALL issues shown to you - both required AND recommended (optional)
        3. NEVER fabricate or guess information - only use data you can verify
        4. If you cannot find verifiable information for a field, use skip_field to mark it as skipped with a reason
        5. For string fields: use appropriate text from verified sources
        6. For number fields: use appropriate numeric values from verified sources
        7. For single_select: choose one valid option ID
        8. For multi_select: choose one or more valid option IDs
        9. For checkboxes: use the appropriate state for the checkbox mode:
           - Mode "simple": done (checked) or todo (unchecked)
           - Mode "multi": done, todo, or na (not applicable)
           - Mode "explicit": yes or no (must explicitly answer)

        CRITICAL: Accuracy is more important than completeness. Use skip_field when information cannot be verified.

        Always use the fill_form tool to submit your field values.


        # Instructions for agent role
        Complete the remaining fields based on the provided context.

        # Field-specific instructions
        **ratings:** Enter rating data with source name, score (0-100), and vote count.
      context_prompt: |-
        # Previous Patch Errors

        Your previous patches were rejected due to the following errors. Please fix these issues:

        - **Error:** Cannot apply set_string to table field "ratings"
          **Correction:** This field is type "table". Use set_table instead.
          **Correct format:** { op: "set_table", fieldId: "ratings", value: [{ "source": "...", "score": "...", "votes": "..." }, ...] }

        # Current Form State

        Below is the complete form with all currently filled values.
        Fields marked with `[ ]` or empty values still need to be filled.

        ```markdown
        ---
        markform:
          spec: "MF/0.1"
        role_instructions:
          user: "Fill in the fields you have direct knowledge of."
          agent: "Complete the remaining fields based on the provided context."
        ---

        {% form id="rejection_test" title="Rejection Test Form" %}

        {% description ref="rejection_test" %}
        A form to test patch rejection scenarios - verifies that type mismatch
        errors are properly recorded and recovery works.
        {% /description %}

        {% group id="fields" title="Test Fields" %}

        {% field kind="table" id="ratings" columnIds=["source", "score", "votes"] columnLabels=["Source", "Score", "Votes"] columnTypes=["string", "number", "number"] label="Ratings" maxRows=5 minRows=1 required=true %}{% /field %}

        {% instructions ref="ratings" %}
        Enter rating data with source name, score (0-100), and vote count.
        {% /instructions %}

        {% field kind="string" id="title" label="Title" required=true %}{% /field %}

        {% /group %}

        {% /form %}

        ```

        # Current Form Issues

        You need to address 2 issues. Here are the current issues:

        - **ratings** (field): Required field "Ratings" is empty
          Severity: required, Priority: P1
          Type: table
          Columns: source, score, votes
          Rows: min: 1, max: 5
          Set: { op: "set_table", fieldId: "ratings", value: [{ "source": "...", "score": "...", "votes": "..." }, ...] }
          This field is required.

        - **title** (field): Required field "Title" is empty
          Severity: required, Priority: P1
          Type: string
          Set: { op: "set_string", fieldId: "title", value: "..." }
          This field is required.

        # General Instructions

        Use the fill_form tool to submit patches for the fields above.
        For table fields, each row is an object with column ID keys.
    wire:
      request:
        system: |-
          # Form Instructions
          Carefully research answers to all questions in the form, using all available tools you have.

          Guidelines:
          1. Focus on required fields first (severity: "required"), then address optional fields (severity: "recommended")
          2. You MUST address ALL issues shown to you - both required AND recommended (optional)
          3. NEVER fabricate or guess information - only use data you can verify
          4. If you cannot find verifiable information for a field, use skip_field to mark it as skipped with a reason
          5. For string fields: use appropriate text from verified sources
          6. For number fields: use appropriate numeric values from verified sources
          7. For single_select: choose one valid option ID
          8. For multi_select: choose one or more valid option IDs
          9. For checkboxes: use the appropriate state for the checkbox mode:
             - Mode "simple": done (checked) or todo (unchecked)
             - Mode "multi": done, todo, or na (not applicable)
             - Mode "explicit": yes or no (must explicitly answer)

          CRITICAL: Accuracy is more important than completeness. Use skip_field when information cannot be verified.

          Always use the fill_form tool to submit your field values.


          # Instructions for agent role
          Complete the remaining fields based on the provided context.

          # Field-specific instructions
          **ratings:** Enter rating data with source name, score (0-100), and vote count.
        prompt: |-
          # Previous Patch Errors

          Your previous patches were rejected due to the following errors. Please fix these issues:

          - **Error:** Cannot apply set_string to table field "ratings"
            **Correction:** This field is type "table". Use set_table instead.
            **Correct format:** { op: "set_table", fieldId: "ratings", value: [{ "source": "...", "score": "...", "votes": "..." }, ...] }

          # Current Form State

          Below is the complete form with all currently filled values.
          Fields marked with `[ ]` or empty values still need to be filled.

          ```markdown
          ---
          markform:
            spec: "MF/0.1"
          role_instructions:
            user: "Fill in the fields you have direct knowledge of."
            agent: "Complete the remaining fields based on the provided context."
          ---

          {% form id="rejection_test" title="Rejection Test Form" %}

          {% description ref="rejection_test" %}
          A form to test patch rejection scenarios - verifies that type mismatch
          errors are properly recorded and recovery works.
          {% /description %}

          {% group id="fields" title="Test Fields" %}

          {% field kind="table" id="ratings" columnIds=["source", "score", "votes"] columnLabels=["Source", "Score", "Votes"] columnTypes=["string", "number", "number"] label="Ratings" maxRows=5 minRows=1 required=true %}{% /field %}

          {% instructions ref="ratings" %}
          Enter rating data with source name, score (0-100), and vote count.
          {% /instructions %}

          {% field kind="string" id="title" label="Title" required=true %}{% /field %}

          {% /group %}

          {% /form %}

          ```

          # Current Form Issues

          You need to address 2 issues. Here are the current issues:

          - **ratings** (field): Required field "Ratings" is empty
            Severity: required, Priority: P1
            Type: table
            Columns: source, score, votes
            Rows: min: 1, max: 5
            Set: { op: "set_table", fieldId: "ratings", value: [{ "source": "...", "score": "...", "votes": "..." }, ...] }
            This field is required.

          - **title** (field): Required field "Title" is empty
            Severity: required, Priority: P1
            Type: string
            Set: { op: "set_string", fieldId: "title", value: "..." }
            This field is required.

          # General Instructions

          Use the fill_form tool to submit patches for the fields above.
          For table fields, each row is an object with column ID keys.
        tools:
          fill_form:
            description: Fill form fields by submitting patches. Each patch sets a value for one field. Use the field IDs from the issues list. Return patches for all issues you can address.
            input_schema:
              $defs:
                patch:
                  description: A patch operation (see tool description for full schema)
              properties:
                patches:
                  description: Array of patches to apply to the form
                  items:
                    $ref: '#/$defs/patch'
                  type: array
              required:
                - patches
              type: object
      response:
        steps:
          - tool_calls:
              - tool_name: fill_form
                input:
                  patches:
                    - field_id: ratings
                      op: set_table
                      value:
                        - score: 85
                          source: IMDB
                          votes: 12500
                        - score: 92
                          source: Rotten Tomatoes
                          votes: 450
                    - field_id: title
                      op: set_string
                      value: Test Movie
            tool_results: []
            text: null
        usage:
          input_tokens: 0
          output_tokens: 0
final:
  expect_complete: true
  expected_completed_form: rejection-test-mock-filled.form.md
